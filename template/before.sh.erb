# Export the module function if it exists

<%- if context.cluster == "my-k8s-cluster" -%>
exec &> >(tee -a "pod.log")

# Export the module function if it exists
[[ $(type -t module) == "function" ]] && export -f module

source /bin/find_host_port
source /bin/save_passwd_as_secret
export host="$HOST_CFG"
export port="$PORT_CFG"

export BIND_PORT=8443

password=$PASSWORD

<%- else -%>
# Find available port to run server on
port=$(find_port ${host})
JUPYTER_PORT="${port}"
HOST_CFG="${host}"
PORT_CFG="${port}"

export BIND_PORT=$port
password="$(create_passwd 16)"
PASSWORD=$password

<%- end -%>

echo "host is: ${host}"
echo "port is: ${port}"

export password PASSWORD

# these are set by pam on normal ssh login
export LMOD_CONFIG_DIR=/opt/nesi/etc/lmod
export MODULEPATH_ROOT=/opt/nesi/lmod
export MODULEPATH=/opt/nesi/lmod/generic
export BASH_ENV=/usr/share/lmod/lmod/init/bash
